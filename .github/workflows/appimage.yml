name: Release Appimage
#concurrency:
  #group: build-${{ github.ref }}
  #cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches: [ "trunk" ]
    paths:
      - '.github/workflows/appimage.yml'
      - 'AppRun'
      - 'version'
      - 'workflow.sh'
  pull_request:
    branches: [ "trunk" ]
    paths:
      - '.github/workflows/appimage.yml'
      - 'AppRun'
      - 'version'
      - 'workflow.sh'

jobs:
  # Label of the container job
  build-appimage:
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-22.04
    env:
      ARCH: x86_64
      WORKSPACE: ${{ github.workspace }}
      VERSION: 0.0.27-svn-unstable
    steps:
    - uses: actions/checkout@v3
    - name: Run Workflow script
      run: |
        $WORKSPACE/workflow.sh

    - name: Release AppImage
      if: ${{ github.ref == 'refs/heads/trunk' }}
      uses: ncipollo/release-action@v1
      with:
        name: 0ad-${{ env.VERSION }} AppImage
        allowUpdates: True
        prerelease: True
        artifacts: "${{ env.WORKSPACE }}/0ad*.AppImage*"
        token: ${{ secrets.GITHUB_TOKEN }}
        omitNameDuringUpdate: True
        omitBodyDuringUpdate: True
        tag: v${{ env.VERSION }}
        replacesArtifacts: true
    - name: Upload Artifacts
      if: ${{ github.ref != 'refs/heads/trunk' }}
      uses: actions/upload-artifact@v3
      with:
        name: AppImage
        path: ${{ env.WORKSPACE }}/0ad*.AppImage*



